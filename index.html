<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Video Generator</title>
  <style>
    :root{--bg:#071029;--card:#0f1724;--accent:#38bdf8;--muted:#94a3b8;--ok:#a3e635;--danger:#ff6b6b;--text:#e6eef8}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071026 0%, #071229 100%);color:var(--text);font-family:Inter,system-ui,Arial,Helvetica,sans-serif;padding:20px}
    .wrap{width:680px;max-width:100%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
    h1{margin:0 0 10px;font-size:20px}
    textarea{width:100%;min-height:110px;resize:vertical;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#061226;color:var(--text);font-size:14px}
    .controls{display:flex;gap:8px;margin-top:12px}
    .controls button{flex:1;padding:11px;border-radius:8px;border:none;background:var(--accent);color:#022;font-weight:700;cursor:pointer}
    #status{margin-top:12px;color:var(--muted);font-size:13px;min-height:18px}
    video{width:100%;margin-top:14px;border-radius:8px;background:#000;display:none}
    .trace{margin-top:12px;background:#071226;padding:10px;border-radius:8px;color:#cfe9ff;max-height:240px;overflow:auto;font-size:12px}
    .error{color:var(--danger);font-weight:600}
    .ok{color:var(--ok);font-weight:600}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>AI Video Generator (Robust)</h1>
    <textarea id="prompt" placeholder="Describe your video... e.g. 'a small robot dancing in neon city'"></textarea>
    <div class="controls">
      <button id="generateBtn">Generate</button>
      <button id="clearBtn" style="background:#334155;color:var(--text)">Clear</button>
    </div>
    <div id="status">Ready</div>
    <video id="video" controls playsinline></video>
    <pre id="trace" class="trace" style="display:none"></pre>
  </main>

  <script>
    const backend = "/generate"; // same-origin; use full URL if different origin
    const promptEl = document.getElementById('prompt');
    const genBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');
    const videoEl = document.getElementById('video');
    const traceEl = document.getElementById('trace');

    function setStatus(txt, cls) {
      statusEl.textContent = txt;
      statusEl.className = cls || '';
    }

    genBtn.addEventListener('click', async () => {
      const prompt = promptEl.value.trim();
      if (!prompt) return alert('Enter a prompt');

      setStatus('Sending request… (this can take 20–90s)', 'small');
      genBtn.disabled = true;
      videoEl.style.display = 'none';
      videoEl.src = '';
      traceEl.style.display = 'none';
      traceEl.textContent = '';

      try {
        const resp = await fetch(backend, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ prompt })
        });

        // read body exactly once
        const raw = await resp.text();
        let data = null;
        try { data = raw ? JSON.parse(raw) : null; } catch (e) { data = null; }

        if (!resp.ok) {
          const errMsg = (data && (data.error || data.details)) || raw || `HTTP ${resp.status}`;
          setStatus('Generation failed: ' + errMsg, 'error');
          traceEl.style.display = 'block';
          traceEl.textContent = raw || JSON.stringify(data, null, 2);
          return;
        }

        // success path
        if (data && data.ok && data.video) {
          const url = Array.isArray(data.video) ? data.video[0] : data.video;
          setStatus('Video ready — loading...', 'ok');
          videoEl.src = url;
          videoEl.style.display = 'block';
          videoEl.oncanplay = () => { try { videoEl.play(); } catch(e){} };
          // show the trace if present
          if (data.trace) {
            traceEl.style.display = 'block';
            traceEl.textContent = JSON.stringify(data.trace, null, 2);
          }
          return;
        }

        // models may return { video: ... } without ok flag — handle that too
        if (data && data.video) {
          const url = Array.isArray(data.video) ? data.video[0] : data.video;
          setStatus('Video ready — loading...', 'ok');
          videoEl.src = url; videoEl.style.display = 'block';
          return;
        }

        // final fallback — no video
        setStatus('Generation failed: No video returned', 'error');
        traceEl.style.display = 'block';
        traceEl.textContent = raw || JSON.stringify(data, null, 2);

      } catch (err) {
        console.error('Request error', err);
        setStatus('Network/server error: ' + (err.message || err), 'error');
        traceEl.style.display = 'block';
        traceEl.textContent = String(err);
      } finally {
        genBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      promptEl.value = '';
      videoEl.style.display = 'none';
      videoEl.src = '';
      traceEl.style.display = 'none';
      traceEl.textContent = '';
      setStatus('Ready');
    });
  </script>
</body>
</html>

